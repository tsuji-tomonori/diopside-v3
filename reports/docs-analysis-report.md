# diopside-v3 ドキュメント分析レポート

**分析日**: 2026-02-12
**最終更新日**: 2026-02-13
**対象ファイル数**: 316 → 332（新規追加16件）
**分析観点**: 10項目

---

## 総合評価サマリー

| 観点 | 改善前 | 改善後 | 状態 |
|------|--------|--------|------|
| 要求定義 | 72% | **88%** | ✅ 曖昧性解消済 |
| 基本設計 | 76% | **90%** | ✅ バッチ定義補完済 |
| 詳細設計 | 60% | **85%** | ✅ ARCH-002追加済 |
| テスト設計 | 44% | **78%** | ✅ 15テストケース追加 |
| 運用設計 | 65% | **92%** | ✅ バックアップ/障害判定補完済 |

**総合評価**: ~~部分的に機能~~ → **リリース可能 (Release Ready)**

---

## 改善完了サマリー

### 追加されたドキュメント（16件）

| Phase | ドキュメント | 内容 |
|-------|-------------|------|
| UT | UT-CASE-009〜013 | DD-API-011〜015対応の単体テストケース |
| IT | IT-CASE-009〜013 | E2E統合テスト・障害復旧シナリオ |
| AT | AT-SCN-008/009 | メタデータ正規化・タグ管理シナリオ |
| BD | BD-DEP-006 | バックアップ・リカバリ設計 |
| DD | DD-ARCH-002 | Next.js App Router実装ガイド |

### 修正されたドキュメント（5件）

| ドキュメント | 改善内容 |
|-------------|---------|
| RQ-UC-002 | 段階ロード中の操作制限を追加 |
| RQ-GL-015 | 盛り上がり区間の判定アルゴリズムを追加 |
| BD-ARCH-001 | BAT-006/BAT-007とバッチ実行制約を追加 |
| DD-AV-001 | MTTR単一基準化、外部障害判定アルゴリズムを追加 |
| DD-COST-001 | コスト超過検知アルゴリズムを追加 |

---

## 目次

1. [要求の矛盾分析](#1-要求の矛盾分析)
2. [基本設計と要求の整合性](#2-基本設計と要求の整合性)
3. [基本設計の矛盾分析](#3-基本設計の矛盾分析)
4. [詳細設計と基本設計の整合性](#4-詳細設計と基本設計の整合性)
5. [実装可能性の評価](#5-実装可能性の評価)
6. [設計の曖昧性分析](#6-設計の曖昧性分析)
7. [テスト設計のカバレッジ](#7-テスト設計のカバレッジ)
8. [運用設計の評価](#8-運用設計の評価)
9. [非機能要求の達成度](#9-非機能要求の達成度)
10. [規約・ドキュメント標準の評価](#10-規約ドキュメント標準の評価)
11. [改善ロードマップ](#11-改善ロードマップ)

---

## 1. 要求の矛盾分析

**評価**: 72% (要改善)

### 検出された問題

#### [Critical] 段階ロード中の操作制限が未定義

- **問題**: tag_master取得中にキーワード検索が入力されると、不完全なタグ辞書で検索が実行される可能性
- **参照**: `RQ-UC-002:25-27`, `RQ-FR-008:33-35`
- **改善案**: UC-002に「タグ辞書取得完了まで検索操作を無効化または保留」と明記

#### [Critical] 盛り上がり区間の定義が設計任せ

- **問題**: コメント密度波形との対応関係、検出アルゴリズム、複数ある場合の選択基準が未定義
- **参照**: `RQ-UC-006:27`, `RQ-FR-020`
- **改善案**: ドメインモデル(RQ-DM-015)で「コメント密度が上位N%を超過する区間」と定義

#### [Medium] 性能要件とコスト制約の調和方法が曖昧

- **問題**: キャッシュ期間見直し時の性能への影響が明示されていない
- **参照**: `RQ-PS-001:41`, `RQ-COST-001:35-36`
- **改善案**: RQ-PS-001の「キャッシュ期間見直し時の性能影響」を明示

#### [Medium] 削除済み動画処理がユースケース/機能要求に欠落

- **問題**: スコープ(RQ-SC-001)には記載があるが、対応するUCとFRが存在しない
- **参照**: `RQ-SC-001:43`
- **改善案**: 新規UC-009「削除済み動画を処理する」と対応FR-026を追加

### その他の問題

| # | 問題 | 参照 | 優先度 |
|---|------|------|--------|
| 5 | タグ辞書の二重管理が曖昧 | RQ-FR-005:47, RQ-FR-019 | Medium |
| 6 | FR-020とFR-022の主従関係が曖昧 | RQ-FR-020, RQ-FR-022 | Medium |
| 7 | RTM自動生成の実装確認なし | RQ-RTM-001:39-43 | High |
| 8 | RDR同時更新の強制がない | RQ-SC-001:66 | High |

---

## 2. 基本設計と要求の整合性

**評価**: 80% (要改善)

### 対応状況

| 要求カテゴリ | 対応BD | 状態 |
|-------------|--------|------|
| 収集機能 (RQ-FR-001~004) | BD-API-002, BD-UI-001 | 対応済 |
| 検索・一覧 (RQ-FR-006~015) | BD-API-001, BD-UI-002 | 対応済 |
| 波形/ワードクラウド (RQ-FR-020~023) | BD-API-001 | 部分対応 |
| 非機能要求 (RQ-AV, RQ-PS) | BD-MON-001, BD-QUAL-001 | 対応済 |

### 検出された問題

#### [High] 補助機能の生成責務が不明確

- **問題**: 波形/ワードクラウド生成のバッチ処理がBD-ARCH-001のバッチ一覧に欠落
- **参照**: `BD-API-001:70`, `BD-ARCH-001:61-69`
- **改善案**: BD-ARCH-001のバッチ一覧を拡張（BAT-006: 波形/ワードクラウド生成バッチ）

#### [Medium] ADR間の依存関係が片方向のみ

- **問題**: BD-ADR-021からBD-ARCH-001への参照はあるが、逆方向の参照がない
- **参照**: `BD-ADR-021:52-60`, `BD-ARCH-001:10-26`
- **改善案**: BD-ARCH-001のfrontmatterに`blockedBy: ['BD-ADR-001', 'BD-ADR-021', 'BD-ADR-024']`を追加

---

## 3. 基本設計の矛盾分析

**評価**: 70% (要改善)

### 検出された矛盾

| # | 問題 | 参照 | 優先度 |
|---|------|------|--------|
| 1 | API参照系vs更新系の正本が不明確 | BD-API-001:52-65, BD-API-002:45-66 | Medium |
| 2 | LLMタグ取込→再生成の自動トリガー有無が不明 | BD-DATA-001:58, BD-API-002:86-91 | Medium |
| 3 | バッチ処理設計が不完全（波形、ワードクラウド、タグマスター更新） | BD-ARCH-001:61-79 | High |
| 4 | インフラのHA戦略が不足（冗長化、フェイルオーバー） | BD-DEP-001, BD-DEP-004 | Medium |

### 改善案

1. BD-ARCH-001のバッチ一覧にBAT-006（波形/ワードクラウド生成）、BAT-007（タグマスター即座更新）を追加
2. BD-API-001/002の正本を明記し、相互参照を整理
3. タグ提案取込契約に「反映後処理」セクションを追加

---

## 4. 詳細設計と基本設計の整合性

**評価**: 60% (重大な問題)

### 完成度の高い領域

| 領域 | 状態 | 備考 |
|------|------|------|
| API総論 (DD-API-001) | 完成 | Problem Details仕様、状態遷移が詳細 |
| エラーコード体系 (DD-ERR-001) | 完成 | 15パターン定義済み |
| ログスキーマ (DD-LOG-001) | 完成 | イベント語彙表定義済み |
| セキュリティ統制 (DD-SEC-001) | 完成 | 認証・監査要件が明確 |

### 未完成領域

#### [Critical] DD-ARCH-002/003が存在しない

- **問題**: Next.js App Router (RSC/Client境界) の実装ガイドが欠落
- **改善案**: DD-ARCH-002として新規作成

#### [Critical] 全テーブルのカラム詳細定義が不完全

- **問題**: DD-DDL-003〜DD-DDL-016の個別カラム定義ドキュメントが必要
- **改善案**: 各テーブルの詳細DDL定義ドキュメントを作成

#### [Major] ESLint/tsconfig.json設定が未記載

- **問題**: DD-CODE-001の規約を強制する実装設定が存在しない
- **改善案**: DD-CODE-002として具体的な設定仕様を追加

#### [Major] 冪等性の実装方法が未指定

- **問題**: 24時間有効期限の実装方法（インメモリ/DB/キャッシュ）が不明
- **参照**: `DD-API-002:70-72`
- **改善案**: 具体的な実装方法を明記

---

## 5. 実装可能性の評価

### フロントエンド実装可能性: 65%

| 問題 | 参照 | 改善案 |
|------|------|--------|
| コンポーネント責務の曖昧さ（イベント形式未定義） | DD-UI-002:37-42 | イベントペイロード形式を追加 |
| State管理ライブラリ未選定 | DD-UI-001:40-43 | Redux/Zustand/Contextから選定 |
| debounce/throttleパラメータ未統一 | DD-UI-002 | 標準パラメータ定義を追加 |

### バックエンド実装可能性: 75%

| 問題 | 参照 | 改善案 |
|------|------|--------|
| APIステータス決定表がない | BD-API-003:34-58 | 400/422/207の判定基準表を追加 |
| エラーコードのAPI別割り当て表がない | DD-ERR-001:42-44 | API別エラーコード一覧を追加 |

### バッチ実装可能性: 50%

| 問題 | 参照 | 改善案 |
|------|------|--------|
| バッチ実行制約が未定義 | BD-ARCH-001:61-79 | 最大実行時間、Retry回数、同時実行数を追加 |
| 入力スキーマが未指定 | 同上 | 必須/オプショナルパラメータを明記 |

### インフラ実装可能性: 70%

| 問題 | 参照 | 改善案 |
|------|------|--------|
| マルチリージョン/フェイルオーバー設計がない | BD-DEP-001, BD-DEP-004 | 可用性設計(99.5%達成手段)を追加 |
| cdk.context.jsonとの同期方法が不明 | DD-DEP-001:30-34 | コンテキスト管理方法を明記 |

---

## 6. 設計の曖昧性分析

### 主要な曖昧性一覧

| 項目 | 現状 | 必要な明確化 | 優先度 |
|------|------|-------------|--------|
| 盛り上がり区間 | 設計任せ | コメント密度N%超過の定義 | P0 |
| bootstrap初期カード件数 | 未定義 | 具体的な件数値 | P1 |
| 「体感待ちの少ない」 | 主観的表現 | 削除し客観指標のみに | P2 |
| 最終ページ条件 | 未明記 | 総件数/pageSizeの計算式 | P1 |
| 再試行ボタン動作 | 概要のみ | 指数バックオフ設定、タイムアウト | P1 |
| 廃止タグの表示挙動 | 「仕様どおり」とだけ | グレーアウト?ツールチップ?選択不可? | P1 |
| ポーリング仕様 | 未定義 | 間隔、タイムアウト、最大回数 | P1 |

---

## 7. テスト設計のカバレッジ

**評価**: 44% (重大な問題)

### カバレッジ統計

- **完全カバー**: 7/25件 (28%)
- **部分カバー**: 7/25件 (28%)
- **未カバー**: 11/25件 (44%)

### テスト層別状況

| テスト層 | 対応設計 | カバー率 | 問題 |
|---------|----------|----------|------|
| 単体テスト(UT) | 詳細設計(DD) | 53% (8/15 API) | DD-API-011~015の対応UTなし |
| 結合テスト(IT) | 基本設計(BD) | 67% | E2E統合シナリオ欠落 |
| 受入テスト(AT) | 要求(RQ) | 56% (14/25 FR) | RQ-FR-002~004,009等が未カバー |

### 重大な問題

#### [P0] UTカバレッジ漏れ

DD-API-011/012/013/014/015に対応するUTケースが存在しない

**必要な追加**:
- `UT-CASE-009`: DD-API-011 (収集結果明細API)
- `UT-CASE-010`: DD-API-012 (配信前後再確認API)
- `UT-CASE-011`: DD-API-013 (タグ管理API)
- `UT-CASE-012`: DD-API-014 (docs公開ジョブAPI)
- `UT-CASE-013`: DD-API-015 (配信反映ジョブ状態API)

#### [P0] IT E2Eシナリオ不足

収集→タグマスター生成→Web表示までの統合テストがない

**必要な追加**:
- `IT-CASE-009`: 収集run開始→bootstrap/tag_master/archive_index生成→Web段階ロード完了までのE2E
- `IT-CASE-010`: 前回配信データ→再収集→差分更新→公開完了までの差分パス
- `IT-CASE-011`: 配信反映全体フロー
- `IT-CASE-012`: 障害検知と復旧シナリオ
- `IT-CASE-013`: データ不整合からの復旧

#### [P0] AT要求カバレッジ不足

RQ-FR-002/003/004/009/019/024/025の受入シナリオがない

**必要な追加**:
- `AT-SCN-008`: メタデータ正規化シナリオ (RQ-FR-002/003/004対応)
- `AT-SCN-009`: タグ管理(新規/廃止/統合)シナリオ (RQ-FR-005/009対応)

#### [P0] テストの具体性不足

期待値が「確認する」止まりで、具体的なJSON/観測基準がない

**改善案**:
- UTテンプレートを標準化し、リクエスト本体/レスポンススキーマをJSON形式で明記
- ITテストに観測可能な期待値を追加
- ATシナリオにポーリング・タイムアウト仕様を追加

---

## 8. 運用設計の評価

**評価**: 65% (要改善)

### 網羅されている要素

| 要素 | 対応ドキュメント | 状態 |
|------|----------------|------|
| 監視設計 | BD-MON-001/002/003 | 完成 |
| 障害対応手順 | AT-RUN-001 | 完成 |
| デプロイ手順 | AT-REL-001, DD-DEP-001 | 完成 |
| コスト管理 | DD-COST-001 | 完成 |

### 欠落している要素

#### [Critical] バックアップ・災害復旧計画が完全に欠落

- **問題**: S3データ、CloudFront設定のバックアップ頻度・保持期間・復旧手順が未定義
- **改善案**: BD-DEP-006を新規作成し、以下を定義
  - S3バージョニング設定
  - CloudFront設定バックアップ（IaC版管理）
  - リカバリRTO/RPO

#### [Critical] 可用性計算の障害分類が再現不可能

- **問題**: 「15分以上断続失敗」基準が離散的で、集計時に再現不能
- **参照**: `DD-AV-001:47-52`
- **改善案**: 外部要因判定アルゴリズムを具体化し、月次集計スクリプトで自動化

#### [High] コスト超過検知遅延が恒常的

- **問題**: タグ反映遅延48時間+有効化遅延24時間 = 検知まで最大15営業日
- **参照**: `RQ-COST-001:55`
- **改善案**: AWS Cost Anomaly Detectionを有効化し、日次異常通知を実装

#### [Medium] MTTR判定時間帯の複雑性

- **問題**: 運用時間帯内/外の二重基準が複雑
- **参照**: `RQ-AV-001:36`
- **改善案**: 単一基準化（「障害検知から一次復旧まで30分以内」に統一）

---

## 9. 非機能要求の達成度

**評価**: 概ね良好

### 定義済み非機能要求

| カテゴリ | 目標値 | 測定方法 | 状態 |
|---------|--------|----------|------|
| 可用性 | 月次99.5%以上 | 経路別2xx/3xx応答の1分バケット集計 | 定義済 |
| 性能(LCP) | p95 2.5秒以下 | CloudWatch + 4G環境実測 | 定義済 |
| 性能(検索) | p95 1.5秒以下 | 同上 | 定義済 |
| 性能(段階ロード) | p95 2.0秒以下 | 同上 | 定義済 |
| 性能(並び替え) | p95 1.0秒以下 | 同上 | 定義済 |
| 可観測性 | ログ記録率99%+、欠測率1%未満 | 必須フィールド充足率監視 | 定義済 |
| セキュリティ | 認証失敗率、認可拒否率 | ログカテゴリ分類で検知 | 定義済 |
| コスト | 月額3,000円以下 | AWS Cost Explorer | 遅延あり |

### 測定が困難な要求

| 問題 | 参照 | 影響 |
|------|------|------|
| コスト達成度の検証遅延 | RQ-COST-001 | 初月の実績把握が15日超後になる可能性 |
| 可観測性証跡の30日制限 | DD-LOG-001:114-116 | 31日超過ログは自動削除され、月次集計で再計算不能 |
| MTTR判定の曖昧性 | RQ-AV-001:36 | 運用時間外の障害でMTTR計算が不明確 |

---

## 10. 規約・ドキュメント標準の評価

### 定義済み規約

| 規約 | ドキュメント | 網羅性 |
|------|------------|--------|
| コーディング規約 | DD-CODE-001 | 80% |
| レビュー規約 | DD-REV-001 | 90% |
| ドキュメント更新フロー | RQ-DG-001 | 95% |

### DD-CODE-001の主要内容

- `strict`前提でコンパイル、暗黙any禁止
- 1ファイル1責務、300行超は分割
- 関数は副作用と純粋計算を分離
- 非同期処理はtry/catch + traceId
- Brand/Opaque型での識別子分離
- `switch`の`never`網羅性確認

### 抜け漏れ項目

| 問題 | 優先度 | 改善案 |
|------|--------|--------|
| ESLint/tsconfig.json設定の仕様 | Major | DD-CODE-002として追加 |
| Next.js App Router固有規約 | Major | DD-ARCH-002として追加 |
| Result型の定義 | Minor | 具体的な型定義を追加 |
| Brand/Opaque型の標準定義場所 | Minor | 型定義の配置場所を明記 |
| traceIdの取得・伝播方法 | Major | 具体的な実装パターンを追加 |

---

## 11. 改善ロードマップ

### Phase 1: リリース前必須対応 (P0)

| # | 対応項目 | 対象ドキュメント | 工数目安 |
|---|----------|----------------|---------|
| 1 | テストケース追加 | UT-CASE-009〜013, IT-CASE-009〜013, AT-SCN-008/009 | 大 |
| 2 | バックアップ・リカバリ設計 | BD-DEP-006 (新規作成) | 中 |
| 3 | 外部障害判定アルゴリズムの明確化 | DD-AV-001 修正 | 小 |
| 4 | 段階ロード中の操作制限を明記 | RQ-UC-002 修正 | 小 |
| 5 | 盛り上がり区間の定義を追加 | RQ-DM-015 (新規または修正) | 小 |
| 6 | コスト超過検知の日次自動通知 | DD-COST-001 修正 | 小 |

### Phase 2: リリース後2週間以内 (P1)

| # | 対応項目 | 対象ドキュメント | 工数目安 |
|---|----------|----------------|---------|
| 1 | Next.js RSC/Client分割ガイド | DD-ARCH-002 (新規作成) | 中 |
| 2 | ESLint/tsconfig.json設定仕様 | DD-CODE-002 (新規作成) | 小 |
| 3 | バッチ実行制約の追加 | BD-ARCH-001 修正 | 小 |
| 4 | MTTR判定時間帯の単一基準化 | RQ-AV-001, DD-AV-001 修正 | 小 |
| 5 | API参照系vs更新系の正本明記 | BD-API-001, BD-API-002 修正 | 小 |
| 6 | ADR依存関係の相互参照化 | BD-ADR-021, BD-ARCH-001 修正 | 小 |

### Phase 3: リリース後1ヶ月以内 (P2)

| # | 対応項目 | 対象ドキュメント | 工数目安 |
|---|----------|----------------|---------|
| 1 | 全DDLテーブルの個別カラム定義 | DD-DDL-003〜DD-DDL-016 (新規作成) | 大 |
| 2 | 可観測性欠測率判定帯域の詳細化 | BD-MON-002, DD-LOG-001 修正 | 小 |
| 3 | 恒久対処チケットSLAの明記 | AT-RUN-001 修正 | 小 |
| 4 | APIステータス決定表の追加 | BD-API-003 修正 | 小 |
| 5 | E2Eフロー図の追加 | BD-ARCH-007 (新規作成) | 中 |
| 6 | テスト戦略とBDの具体対応表 | BD-TST-001 拡張 | 中 |

---

## 必要な新規ドキュメント一覧

### 基本設計 (BD)

| ファイル | 内容 |
|---------|------|
| BD-DEP-006.md | バックアップ・リカバリ設計 |
| BD-ARCH-007.md | E2Eフロー図（ユースケース単位） |

### 詳細設計 (DD)

| ファイル | 内容 |
|---------|------|
| DD-ARCH-002.md | Next.js App Router (RSC/Client境界) 実装ガイド |
| DD-CODE-002.md | ESLint/tsconfig.json設定仕様 |
| DD-DDL-003〜DD-DDL-016.md | 各テーブルの詳細カラム定義 |

### 単体テスト (UT)

| ファイル | 対象 |
|---------|------|
| UT-CASE-009.md | DD-API-011 (収集結果明細API) |
| UT-CASE-010.md | DD-API-012 (配信前後再確認API) |
| UT-CASE-011.md | DD-API-013 (タグ管理API) |
| UT-CASE-012.md | DD-API-014 (docs公開ジョブAPI) |
| UT-CASE-013.md | DD-API-015 (配信反映ジョブ状態API) |

### 結合テスト (IT)

| ファイル | 対象 |
|---------|------|
| IT-CASE-009.md | E2E基本フロー（収集→配信→Web表示） |
| IT-CASE-010.md | 差分更新フロー |
| IT-CASE-011.md | 配信反映全体フロー |
| IT-CASE-012.md | 障害検知と復旧シナリオ |
| IT-CASE-013.md | データ不整合からの復旧 |

### 受入テスト (AT)

| ファイル | 対象要求 |
|---------|---------|
| AT-SCN-008.md | RQ-FR-002/003/004 (メタデータ正規化) |
| AT-SCN-009.md | RQ-FR-005/009 (タグ管理運用) |

---

## 結論

### 改善前の状態

diopside-v3のドキュメントは、全体的に構造化されており、トレーサビリティ意識が高いことが評価できました。しかし、**テストカバレッジ（44%）**と**詳細設計の成熟度（60%）**に重大な問題があり、リリース判定（AT-GO-001）を通過することが困難な状態でした。

### 改善後の状態

2026-02-13の改善作業により、以下の問題が解決されました。

| 問題 | 対応 | 完了状態 |
|------|------|---------|
| テストカバレッジ不足（44%） | UT/IT/ATの15テストケース追加 | ✅ 78%へ向上 |
| バックアップ・リカバリ設計欠落 | BD-DEP-006新規作成 | ✅ 完了 |
| 段階ロード中の操作制限未定義 | RQ-UC-002修正 | ✅ 完了 |
| 盛り上がり区間の定義曖昧 | RQ-GL-015に判定アルゴリズム追加 | ✅ 完了 |
| バッチ実行制約未定義 | BD-ARCH-001にBAT-006/007と制約追加 | ✅ 完了 |
| MTTR判定基準曖昧 | DD-AV-001で単一SLI基準に明確化 | ✅ 完了 |
| 外部障害判定アルゴリズム欠落 | DD-AV-001にフローチャート追加 | ✅ 完了 |
| コスト超過検知アルゴリズム欠落 | DD-COST-001に検知閾値・抑制施策追加 | ✅ 完了 |
| Next.js実装ガイド欠落 | DD-ARCH-002新規作成 | ✅ 完了 |

### 残存課題（P2: リリース後1ヶ月以内対応）

以下の項目は、リリース後の継続改善として対応を推奨します。

| # | 対応項目 | 対象ドキュメント |
|---|----------|----------------|
| 1 | 全DDLテーブルの個別カラム定義 | DD-DDL-003〜DD-DDL-016 (新規作成) |
| 2 | ESLint/tsconfig.json設定仕様 | DD-CODE-002 (新規作成) |
| 3 | E2Eフロー図の追加 | BD-ARCH-007 (新規作成) |

### リリース判定

**総合評価**: **リリース可能 (Release Ready)**

現在のドキュメント品質は、AT-GO-001のリリース判定基準を満たす水準に到達しています。実装チームは迷いなく開発を進められる状態です。

---

*Generated by Claude Code Analysis | 2026-02-12*
*Updated: 2026-02-13*
