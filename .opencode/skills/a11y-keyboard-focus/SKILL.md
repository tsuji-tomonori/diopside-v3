---
name: a11y-keyboard-focus
description: キーボード操作・フォーカス管理・フォーカス可視化・Focus Not Obscured(AA)を実装/レビューする
compatibility: opencode
metadata:
  standard: WCAG-2.2
  level: AA
  lang: ja
  area: keyboard-focus
---

# a11y-keyboard-focus

## 目的
キーボードのみで操作でき、フォーカス移動が予測可能で、フォーカスが常に視認でき、かつコンテンツに隠されないUIを実装します。  
特にWCAG 2.2で追加された **2.4.11 Focus Not Obscured (Minimum)** を含めて、モーダル/固定ヘッダ/トースト等があるクラウドWebアプリでの実装品質を担保します。

## 対象となる達成基準（WCAG 2.2）
- 2.1.1 キーボード（A）
- 2.1.2 キーボードトラップなし（A）
- 2.1.4 文字キーショートカット（A）
- 2.4.3 フォーカス順序（A）
- 2.4.7 フォーカスの可視化（AA）
- 2.4.11 隠されないフォーカス（最低限）（AA）
- （関連）2.4.1 ブロックスキップ（A）、2.4.4 リンクの目的（A）

## 入力として必要な情報
- 対象画面/コンポーネント（モーダル、ドロップダウン、タブ、サイドバー等）
- フォーカスを伴うUI状態遷移（遷移図 or 代表シナリオ）
- キーボードショートカットの有無（単一キー割当て等）

## 実施手順
### 1) キーボード操作で完結するかを確認し、阻害要因を除去
- すべての操作要素が `Tab` で到達できる（フォーカス可能）
- `Enter/Space` で起動できる（ボタン/トグル等）
- メニューやタブなど、矢印キーでの移動が期待されるUIは、期待に沿った操作を実装
- キーボードトラップ（抜けられない）を作らない
  - モーダル内はフォーカスを閉じ込めるが、**Esc** で閉じる・閉じる手段がある・閉じたら元の要素へ戻す

### 2) フォーカス順序を「視覚順」と「DOM順」で整合させる
- 基本方針: DOM順 = 表示順（例外は最小限）
- `tabindex` は原則 0（または未指定）で、`tabindex>0` は避ける
- “ロービング tabindex” を使う場合（メニュー/タブ等）:
  - コンテナへのTab到達後、矢印キーで内部移動、現在要素のみ `tabindex=0`、その他は `-1`

### 3) フォーカス可視化（2.4.7）を担保する
- `:focus-visible` を基本に、キーボード操作時に明確なアウトラインを表示
- “消す” のは原則禁止（`outline: none` のみ、等）
- フォーカスリングが背景/境界と区別できるコントラストを確保（非テキストコントラストの観点も併用）

### 4) Focus Not Obscured (Minimum)（2.4.11）への対処
**典型的に問題が起きるケース**
- 固定ヘッダ/フッタがあり、アンカー遷移やフォーカス移動時に要素が隠れる
- モーダル/ドロワー/ポップオーバーが、背後のフォーカス要素を隠す
- トースト/バナーが画面下部に重なり、フォーカスを覆う

**実装パターン**
- `scrollIntoView()` を使う場合は、固定ヘッダ分の余白を考慮（`scroll-margin-top` / `scroll-padding-top` 等）
- フォーカス移動後に、要素が完全に隠れていないことを確認する（必要なら追加スクロール）
- モーダル表示中は背後を `inert`（または同等の手段）にし、背後にフォーカスが行かないようにする
- オーバーレイUIがフォーカスを覆う場合は、位置・レイヤー・サイズを見直す（フォーカスリングだけが見える実装は不可）

### 5) 文字キーショートカット（2.1.4）を安全にする
- 単一キーショートカットがある場合:
  - 無効化できる、再割り当てできる、またはフォーカス時のみ有効 などの回避策を提供

## 受入基準 / Definition of Done
- 主要ユースケースがキーボードのみで完了する（マウス/タッチ不要）
- Tab移動が予測可能で、見た目の順序と一致している
- フォーカスが常に視認できる（カスタムスタイルでもOK）
- フォーカスが固定要素/オーバーレイ等で完全に隠れない（2.4.11）
- モーダル/メニュー等でフォーカス管理（初期フォーカス、トラップ、復帰）が正しい

## 手動テスト手順（最小セット）
- キーボードのみでログイン→主要導線→ログアウトまで完遂できる
- 200%ズーム、または狭幅（例: 320px相当）で同様に確認
- モーダルを開く→閉じる→元の位置へフォーカス復帰
- “本文へスキップ” が機能し、mainへ飛ぶ

## よくある落とし穴
- `div` クリック要素で `Space` が効かない
- フォーカスリングをCSSで消している
- `scrollIntoView()` で固定ヘッダに隠れてしまう（2.4.11違反）
- モーダル表示中に背後へTab移動できてしまう
