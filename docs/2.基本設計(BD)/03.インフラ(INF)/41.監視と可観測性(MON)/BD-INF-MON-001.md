---
id: BD-INF-MON-001
title: 監視設計
doc_type: 監視設計
phase: BD
version: 1.0.3
status: 下書き
owner: RQ-SH-001
created: 2026-01-31
updated: '2026-02-20'
up:
- '[[RQ-SC-001]]'
- '[[RQ-OBY-001]]'
- '[[RQ-AV-001]]'
- '[[RQ-PS-001]]'
related:
- '[[BD-SYS-ARCH-001]]'
- '[[BD-INF-MON-002]]'
- '[[BD-INF-MON-003]]'
- '[[BD-SYS-ADR-006]]'
- '[[BD-SYS-ADR-008]]'
- '[[BD-SYS-ADR-022]]'
- '[[BD-SYS-ADR-027]]'
- '[[DD-APP-LOG-001]]'
- '[[DD-SYS-AV-001]]'
- '[[DD-SYS-PERF-001]]'
- '[[AT-OPS-001]]'
tags:
- diopside
- BD
- MON
---


## 目的
- [[RQ-OBY-001]] / [[RQ-AV-001]] / [[RQ-PS-001]] を、日次運用で再現可能な監視仕様へ落とし込む。
- 監視対象、観測点、SLI定義を固定し、判定と復旧判断の揺れを防ぐ。

## 監視対象と観測点
| 対象 | 観測点 | 主な異常 | 一次対応 |
| --- | --- | --- | --- |
| 収集run | run開始/完了、成功件数、失敗件数、実行時間 | 連続失敗、失敗率急増、停止 | [[RQ-GL-011|再収集]]対象判定 |
| 配信経路 | `/web` `/docs` `/openapi` `/api/v1` の経路別成功率 | 経路別4xx/5xx急増、到達不可 | 影響経路の切り分け |
| 検索操作 | 検索/絞り込み/並び替えの操作p95 | p95超過継続 | キャッシュと索引状態確認 |
| 認証境界 | 認証失敗率、認可拒否率、検証失敗率 | 境界誤設定、急増 | 認証経路の一次遮断と確認 |
| ログ品質 | 必須フィールド充足率、欠測率、通知遅延 | 記録漏れ、欠測継続 | 監視基盤障害として復旧優先 |
| 上流APIクォータ | 残クォータ、消費速度、枯渇予測時刻 | 閾値割れ、急消費 | 起動制限と翌日再開へ切替 |
| バッチ実行基盤 | キュー滞留、再試行回数、同時実行数 | 滞留増加、再試行枯渇 | 同時実行抑制と失敗run分離 |

## SLI定義
| 分類 | SLI | 目標値 | 判定周期 |
| --- | --- | --- | --- |
| 可用性 | 経路別成功率（2xx/3xx） | 月次 99.5%以上 | 日次/月次 |
| 性能 | 操作系p95（検索、詳細、配信反映確認） | [[RQ-PS-001]] 閾値内 | 日次 |
| 可観測性 | 必須フィールド充足率 | 99%以上 | 日次 |
| 可観測性 | 欠測率 | 1%以下（5%超はCritical） | 日次 |
| セキュリティ | 認証失敗率、認可拒否率 | 異常急増なし | 日次 |
| 運用安定性 | キュー滞留時間p95 | 120秒以下 | 日次 |
| 運用安定性 | 再試行回数上限到達率 | 1%未満 | 日次 |
| 外部依存 | YouTube API残クォータ率 | 10%以上 | 1時間 |

## 欠測時の扱いと[[RQ-GL-011|再収集]]導線
- 監視欠測が発生した日は可用性判定を保留し、欠測回復後に再算出する。
- 収集runで `failed_count > 0` かつ連続失敗3回以上の場合、対象runを[[RQ-GL-011|再収集]]候補へ移送する。
- [[RQ-GL-011|再収集]]は「失敗原因が入力データ欠損または一時外部要因で、恒久不整合がない」場合に実行する。
- 再実行後も同一失敗が継続する場合は、[[RQ-GL-011|再収集]]を停止して障害切り分けへ切替える。

## アラートしきい値
- YouTube残クォータ率 `< 10%` で WARN、`< 5%` で CRITICAL。
- キュー滞留時間p95 `> 120秒` で WARN、`> 300秒` で CRITICAL。
- 同一runの再試行が3回上限到達で ERROR、連続3run上限到達で CRITICAL。

## 変更履歴
- 2026-02-20: INF章再編に合わせて監視・可観測性章へ再配置 [[BD-SYS-ADR-036]]
- 2026-02-13: クォータ残量/キュー滞留/再試行回数の監視対象・SLI・アラートしきい値を追加 [[BD-SYS-ADR-027]]
- 2026-02-10: 新規作成 [[BD-SYS-ADR-006]]
- 2026-02-11: 監視対象/観測点/SLI定義、欠測時運用、[[RQ-GL-011|再収集]]判定条件を追加して定型記述を解消 [[BD-SYS-ADR-006]]
