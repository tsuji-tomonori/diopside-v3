---
id: BD-SYS-ADR-027
title: バッチ実行制約と補助データ生成の運用境界を固定する
doc_type: アーキテクチャ決定記録
phase: BD
version: 1.0.1
status: 下書き
owner: RQ-SH-001
created: 2026-02-13
updated: '2026-02-14'
up:
  - '[[RQ-FR-001]]'
  - '[[RQ-FR-022]]'
  - '[[RQ-FR-023]]'
related:
  - '[[BD-SYS-ARCH-001]]'
  - '[[BD-APP-API-001]]'
  - '[[BD-APP-API-002]]'
  - '[[BD-APP-API-005]]'
  - '[[BD-APP-DATA-001]]'
  - '[[BD-INF-MON-001]]'
  - '[[DD-APP-API-002]]'
  - '[[DD-APP-API-014]]'
  - '[[DD-APP-LOG-001]]'
tags:
  - diopside
  - BD
  - ADR
---

## 決定事項
- バッチ実行制約は `BD-APP-API-002` を正本として、全バッチの最大実行時間・再試行・同時実行数を定義する。
- 補助データ生成（波形/[[RQ-GL-017|ワードクラウド]]）は BAT-006 に集約し、入力必須列を `meta_type` / `message_text` とする。
- コメント密度検出パターンの初期値は `草|w|くさ|kusa` とし、環境設定による上書きを許可する。
- 上流APIクォータ枯渇時は同日自動再実行を行わず、翌日再開候補として扱う。
- docs公開runは部分失敗時に `rollback_pending` を経由して旧版復帰する状態遷移を採用する。
- CORS/レート制限/trace伝播/ログ日次エクスポートをAPI・監視・[[DD-APP-LOG-001|ログ設計]]に同時適用する。

## 理由
- docs-analysis-report v2.0 で、バッチ制約・入力スキーマ・クォータ障害・公開失敗復旧・監視証跡が未解決として残っていた。
- `.workspace` の既存Lambda群は実行制約や入力列を暗黙前提にしており、文書側で明示しないと実装差分で回帰しやすい。

## 影響
- [[BD-APP-API-002]]: バッチ一覧/イベント/実行制約、BAT-006入出力契約、同時実行制御の正本を保持。
- [[BD-SYS-ARCH-001]]: バッチ仕様の記述を境界方針へ整理し、正本参照へ変更。
- [[BD-APP-API-002]] / [[DD-APP-API-002]]: クォータ/レート制御、フォールバック、冪等性保存方式を追加。
- [[DD-APP-API-014]]: docs公開失敗時ロールバック状態遷移を追加。
- [[BD-APP-API-005]]: CORS/レート制限を追加。
- [[BD-INF-MON-001]] / [[DD-APP-LOG-001]]: クォータ監視、キュー滞留監視、trace伝播、30日保持補完を追加。

## 却下した選択肢
- 収集・補助生成を別サービスへ分離する案: 現行運用規模では複雑性過多のため不採用。
- クォータ枯渇時に無条件リトライを継続する案: 枯渇悪化とコスト増を招くため不採用。

## 変更履歴
- 2026-02-14: バッチ実行制約の正本を `BD-SYS-ARCH-001` から `BD-APP-API-002` へ移管し、影響範囲を更新 [[BD-SYS-ADR-027]]
- 2026-02-13: 新規作成（バッチ制約/補助生成/クォータ制御/ロールバック運用の固定） [[BD-SYS-ADR-027]]
